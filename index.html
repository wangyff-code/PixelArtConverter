<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç´ ç”»è½¬æ¢å™¨ (Pixel Art Converter)</title>
    <style>
        :root {
            /* ç™½è‰²ä¸»é¢˜å˜é‡ */
            --bg-color: #f0f2f5;
            --panel-color: #ffffff;
            --text-color: #333333;
            --border-color: #ddd;
            --accent-color: #4a90e2;
            --accent-hover: #357abd;
        }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡å­— */
        }
        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }
        
        /* å·¦ä¾§è®¾ç½®æ  */
        .sidebar {
            width: 320px;
            background-color: var(--panel-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        h2 { margin-top: 0; font-size: 1.5rem; color: #1a1a1a; }
        h3 { margin: 0; font-size: 1.1rem; color: #555; }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        label {
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
        }
        .sub-label {
            font-size: 0.8em;
            color: #888;
            font-weight: normal;
        }
        
        input[type="number"], input[type="text"] {
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            color: var(--text-color);
            border-radius: 6px;
            transition: border 0.2s;
        }
        input[type="number"]:focus { border-color: var(--accent-color); outline: none; }
        
        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */
        .file-upload-btn {
            background-color: #f8f9fa;
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px dashed #ccc;
            color: #666;
            transition: border-color 0.2s;
        }
        .file-upload-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        #fileInput { display: none; }

        /* å³ä¾§å±•ç¤ºåŒºå¸ƒå±€ */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        /* é¢„è§ˆåŒº (Canvaså®¹å™¨) */
        .preview-area {
            flex: 1;
            background-color: #e5e5e5;
            background-image: 
                linear-gradient(45deg, #ddd 25%, transparent 25%), 
                linear-gradient(-45deg, #ddd 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ddd 75%), 
                linear-gradient(-45deg, transparent 75%, #ddd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* æ–°å¢ï¼šå…‰æ ‡æ ·å¼ */
            cursor: grab;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        /* æ–°å¢ï¼šæŠ“å–æ—¶çš„å…‰æ ‡ */
        .preview-area:active {
            cursor: grabbing;
        }

        /* æ–°å¢ï¼šæ‹–æ‹½æ–‡ä»¶è¿›å…¥æ—¶çš„é«˜äº®æ ·å¼ */
        .preview-area.drag-over {
            border: 3px dashed var(--accent-color);
            background-color: rgba(74, 144, 226, 0.1);
        }

        /* ç»“æœå›¾ç‰‡ */
        #resultImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            transform-origin: center center;
            /* ç§»é™¤ transitionï¼Œå› ä¸ºæ‹–æ‹½æ—¶éœ€è¦å®æ—¶å“åº” */
            /* transition: transform 0.1s ease-out; */ 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€å›¾ç‰‡ä½œç”¨äºå®¹å™¨ï¼Œæ–¹ä¾¿æ‹–æ‹½ */
        }

        /* è‰²å¡åŒºåŸŸæ ·å¼ */
        .palette-area {
            min-height: 100px;
            flex-shrink: 0;
            background-color: var(--panel-color);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .palette-scroll {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            width: 100%;
            align-items: flex-start;
            overflow: visible;
        }
        
        .palette-swatch {
            width: 38px;
            height: 38px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .palette-swatch:hover { 
            transform: scale(1.15); 
            z-index: 10; 
            border-color: #000; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .placeholder { 
            color: #999; 
            pointer-events: none; 
            font-size: 1.2rem; 
            text-align: center;
            line-height: 1.5;
        }
        
        .radio-group { display: flex; gap: 20px; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        
        .zoom-hint {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #666;
            pointer-events: none;
            z-index: 10;
        }
        
        .save-hint-text {
            text-align: center;
            color: #888;
            font-size: 0.85rem;
            margin-top: 5px;
            font-style: italic;
        }

        /* ============ æ–°å¢ï¼šå³é”®èœå•æ ·å¼ ============ */
        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 160px;
            padding: 5px 0;
            overflow: hidden;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
            color: var(--accent-color);
        }

        .context-menu-separator {
            height: 1px;
            background-color: #eee;
            margin: 4px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>è®¾ç½® (Settings)</h2>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="control-group">
            <label>è¾“å…¥å›¾ç‰‡</label>
            <label for="fileInput" class="file-upload-btn" id="fileName">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡...</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- åˆ†è¾¨ç‡ -->
        <div class="control-group">
            <label>ç›®æ ‡åˆ†è¾¨ç‡</label>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="res" value="128" checked> 128x128</label>
                <label class="radio-label"><input type="radio" name="res" value="256"> 256x256</label>
            </div>
        </div>

        <!-- æ¸©åº¦ -->
        <div class="control-group">
            <label>æ¸©åº¦ (é”åº¦)</label>
            <div style="display:flex; gap:10px; align-items: center;">
                <input type="range" id="tempRange" min="0.0001" max="1" step="0.0001" value="0.01" style="flex:1">
                <input type="number" id="tempInput" value="0.01" min="0.0001" max="1" step="0.0001" style="width: 80px;">
            </div>
        </div>

        <!-- å™ªå£° -->
        <div class="control-group">
            <label>å™ªå£°å¼ºåº¦ (åˆ›æ„åº¦)</label>
            <input type="number" id="noiseAmp" value="0.1" step="0.1">
        </div>

        <!-- ç§å­ -->
        <div class="control-group">
            <label>éšæœºç§å­ (Seed)</label>
            <span class="sub-label">è®¾ç½®ä¸º -1 ä»¥è·å¾—éšæœºç»“æœ</span>
            <input type="number" id="seedInput" value="-1" step="1">
        </div>

        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <button id="generateBtn" onclick="runInference()">ç”Ÿæˆåƒç´ ç”»</button>
            <div class="save-hint-text">æç¤ºï¼šå³é”®ç‚¹å‡»å›¾ç‰‡å¯å¤åˆ¶æˆ–ä¿å­˜</div>
        </div>
        
        <div id="statusMsg" style="color: #666; font-size: 0.85em; text-align: center; min-height: 1.2em; margin-top: 5px;"></div>
    </div>

    <div class="right-panel">
        <!-- é¢„è§ˆåŒº (å¢åŠ  id ä»¥ä¾¿ JS è°ƒç”¨) -->
        <div class="preview-area" id="imageContainer" onwheel="handleZoom(event)">
            <span class="placeholder" id="placeholderText">
                æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„<br>æˆ–ç‚¹å‡»å·¦ä¾§ä¸Šä¼ <br>
                <span style="font-size:0.8em; opacity:0.7">ï¼ˆæ»šè½®ç¼©æ”¾ / å·¦é”®æ‹–åŠ¨å¹³ç§»ï¼‰</span>
            </span>
            <img id="resultImage" style="display: none;">
            <div class="zoom-hint" id="zoomHint" style="display: none;">æ»šè½®ç¼©æ”¾ / æ‹–æ‹½ç§»åŠ¨</div>
        </div>

        <!-- è‰²å¡åŒº (ç‹¬ç«‹) -->
        <div class="palette-area">
            <h3>è‰²å¡ (32è‰²)</h3>
            <div class="palette-scroll" id="paletteContainer">
                <span style="color:#999; font-size: 0.9em;">è‰²å¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="copyImageToClipboard()">
        <span>ğŸ“‹</span> å¤åˆ¶å›¾ç‰‡ (Copy)
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="saveImageToDisk()">
        <span>ğŸ’¾</span> å¦å­˜ä¸º... (Save As)
    </div>
</div>

<script>
    let currentImageBase64 = null;
    // è§†å›¾çŠ¶æ€å˜é‡
    let currentScale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startDragX = 0;
    let startDragY = 0;

    // UI è”åŠ¨
    const tempRange = document.getElementById('tempRange');
    const tempInput = document.getElementById('tempInput');
    const imageContainer = document.getElementById('imageContainer');
    const resultImage = document.getElementById('resultImage');

    tempRange.addEventListener('input', (e) => tempInput.value = e.target.value);
    tempInput.addEventListener('input', (e) => tempRange.value = e.target.value);

    // ============ æ–‡ä»¶å¤„ç† (ç‚¹å‡» + æ‹–æ‹½) ============
    
    // ç‚¹å‡»ä¸Šä¼ 
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) loadFile(file);
    }

    // æ‹–æ‹½ä¸Šä¼ é€»è¾‘
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageContainer.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // é«˜äº®æ•ˆæœ
    imageContainer.addEventListener('dragover', () => imageContainer.classList.add('drag-over'));
    imageContainer.addEventListener('dragleave', () => imageContainer.classList.remove('drag-over'));

    // æ”¾ä¸‹æ–‡ä»¶
    imageContainer.addEventListener('drop', (e) => {
        imageContainer.classList.remove('drag-over');
        const dt = e.dataTransfer;
        const file = dt.files[0];
        if (file) loadFile(file);
    });

    // æ ¸å¿ƒåŠ è½½å‡½æ•°
    function loadFile(file) {
        // ç®€å•æ ¡éªŒæ˜¯å¦ä¸ºå›¾ç‰‡
        if (!file.type.startsWith('image/')) {
            alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
        }

        document.getElementById('fileName').textContent = file.name.length > 20 ? file.name.substring(0, 17) + "..." : file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageBase64 = e.target.result;
            resultImage.src = currentImageBase64;
            resultImage.style.display = 'block';
            
            // é‡ç½®è§†å›¾
            resetView();
            
            document.getElementById('placeholderText').style.display = 'none';
            document.getElementById('zoomHint').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // ============ å¹³ç§»ä¸ç¼©æ”¾é€»è¾‘ (Pan & Zoom) ============

    // 1. é¼ æ ‡æ»šè½®ç¼©æ”¾
    function handleZoom(event) {
        if (resultImage.style.display === 'none') return;
        event.preventDefault();
        
        const zoomSpeed = 0.1;
        const delta = -Math.sign(event.deltaY);
        const newScale = currentScale + (delta * zoomSpeed);
        
        if (newScale > 0.1 && newScale < 20) {
            currentScale = newScale;
            updateImageTransform();
        }
    }

    // 2. é¼ æ ‡æ‹–æ‹½å¹³ç§»
    imageContainer.addEventListener('mousedown', (e) => {
        if (resultImage.style.display === 'none') return;
        // åªæœ‰å·¦é”®(0)å¯ä»¥æ‹–æ‹½ï¼Œä¸”ä¸æ˜¯åœ¨å³é”®èœå•ä¸Š
        if (e.button !== 0) return;

        isDragging = true;
        startDragX = e.clientX - translateX;
        startDragY = e.clientY - translateY;
        imageContainer.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        
        translateX = e.clientX - startDragX;
        translateY = e.clientY - startDragY;
        
        requestAnimationFrame(updateImageTransform);
    });

    window.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            imageContainer.style.cursor = 'grab';
        }
    });

    function resetView() {
        currentScale = 1;
        translateX = 0;
        translateY = 0;
        updateImageTransform();
    }

    function updateImageTransform() {
        // å…ˆç§»åŠ¨ï¼Œå†ç¼©æ”¾ (æ³¨æ„ï¼šè¿™é‡Œçš„ transform-origin æ˜¯ center center)
        resultImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    }

    // ============ æ¨ç†ä¸å…¶ä»–é€»è¾‘ ============

    // è°ƒç”¨ Python ç”Ÿæˆ
    async function runInference() {
        if (!currentImageBase64) {
            alert("è¯·å…ˆé€‰æ‹©æˆ–æ‹–æ‹½ä¸€å¼ å›¾ç‰‡ï¼");
            return;
        }

        const btn = document.getElementById('generateBtn');
        const status = document.getElementById('statusMsg');
        
        btn.disabled = true;
        btn.textContent = "æ­£åœ¨å¤„ç†...";
        status.textContent = "æ­£åœ¨è¿è¡Œ ONNX æ¨ç†...";

        const settings = {
            image: currentImageBase64,
            resolution: document.querySelector('input[name="res"]:checked').value,
            temperature: parseFloat(document.getElementById('tempInput').value),
            seed: parseInt(document.getElementById('seedInput').value),
            noise_amp: parseFloat(document.getElementById('noiseAmp').value)
        };

        try {
            const response = await pywebview.api.process_image(settings);
            
            if (response.status === 'success') {
                resultImage.src = response.image; // æ›´æ–°å›¾ç‰‡
                renderPalette(response.colors);
                status.textContent = `å®Œæˆ! è€—æ—¶: ${response.time.toFixed(2)}ç§’`;
            } else {
                alert("é”™è¯¯: " + response.message);
                status.textContent = "å‘ç”Ÿé”™è¯¯";
            }
        } catch (e) {
            alert("ç³»ç»Ÿé”™è¯¯: " + e);
        } finally {
            btn.disabled = false;
            btn.textContent = "ç”Ÿæˆåƒç´ ç”»";
        }
    }

    // æ¸²æŸ“è‰²æ¿ HTML
    function renderPalette(colors) {
        const container = document.getElementById('paletteContainer');
        container.innerHTML = '';
        
        if (!colors || colors.length === 0) {
            container.innerHTML = '<span style="color:#999">æœªæ£€æµ‹åˆ°é¢œè‰²</span>';
            return;
        }

        colors.forEach(colorHex => {
            const div = document.createElement('div');
            div.className = 'palette-swatch';
            div.style.backgroundColor = colorHex;
            div.title = colorHex;
            
            div.onclick = () => {
                navigator.clipboard.writeText(colorHex);
                document.getElementById('statusMsg').textContent = `å·²å¤åˆ¶é¢œè‰² ${colorHex}`;
            };
            
            container.appendChild(div);
        });
    }

    // ============ å³é”®èœå•é€»è¾‘ ============
    const contextMenu = document.getElementById('contextMenu');

    // ç›‘å¬å›¾ç‰‡çš„å³é”®ç‚¹å‡»
    // æ”¹ä¸ºç›‘å¬ containerï¼Œè¿™æ ·æ‹–æ‹½æ—¶å¦‚æœç‚¹ç©ºäº†ä¹Ÿèƒ½è§¦å‘ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ï¼Œæˆ–è€…ä¿æŒåªåœ¨imgä¸Šè§¦å‘
    // è¿™é‡Œä¿æŒåœ¨ container ä¸Šç›‘å¬ï¼Œä»¥ä¾¿ç”¨æˆ·åœ¨å›¾ç‰‡ç¼©å°åä¹Ÿèƒ½åœ¨å‘¨å›´ç‚¹å‡»
    imageContainer.addEventListener('contextmenu', function(e) {
        e.preventDefault(); 
        if (resultImage.style.display === 'none' || !resultImage.src) return;

        const x = e.pageX;
        const y = e.pageY;
        
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.style.display = 'block';
    });

    document.addEventListener('click', function(e) {
        if (e.target.closest('#contextMenu')) return;
        contextMenu.style.display = 'none';
    });

    async function copyImageToClipboard() {
        contextMenu.style.display = 'none';
        const status = document.getElementById('statusMsg');
        try {
            const src = resultImage.src;
            const response = await fetch(src);
            const blob = await response.blob();
            await navigator.clipboard.write([
                new ClipboardItem({ [blob.type]: blob })
            ]);
            status.textContent = "å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼";
        } catch (err) {
            console.error(err);
            status.textContent = "å¤åˆ¶å¤±è´¥ï¼Œæµè§ˆå™¨å®‰å…¨é™åˆ¶ã€‚";
        }
    }

    function saveImageToDisk() {
        contextMenu.style.display = 'none';
        const src = resultImage.src;
        if(!src) {
            alert("æ²¡æœ‰å›¾ç‰‡å¯ä¿å­˜");
            return;
        }
        const status = document.getElementById('statusMsg');
        status.textContent = "æ­£åœ¨æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†...";
        try {
            pywebview.api.save_image(src);
        } catch (e) {
            status.textContent = "ç³»ç»Ÿé”™è¯¯";
        }
    }
</script>

</body>
</html>